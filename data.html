<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MTN Data Purchase</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js"></script>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 0; 
            padding: 20px; 
            background: #f5f5f5; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            height: 100vh;
        }
        .container {
            max-width: 450px; 
            width: 100%;
            background: #fff; 
            padding: 20px; 
            border-radius: 15px; 
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
        }
        .welcome-message {
            color: #ff4500;
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 15px;
            overflow: hidden;
            white-space: nowrap;
            border: 2px solid #ff4500;
            padding: 10px;
            animation: scrollMessage 10s linear infinite;
        }
        @keyframes scrollMessage {
            from { transform: translateX(100%); }
            to { transform: translateX(-100%); }
        }
        .balance {
            font-size: 20px; 
            font-weight: bold; 
            margin-bottom: 20px; 
            color: green;
        }
        label { display: block; margin: 10px 0 5px; }
        select, input, button { 
            width: 100%; 
            padding: 10px; 
            margin-top: 5px; 
            border-radius: 10px;
            border: 1px solid #ccc;
        }
        button {
            background: green; 
            color: white; 
            border: none; 
            font-weight: bold;
        }
        button:hover { background: darkgreen; }
    </style>
</head>
<body>

<div class="container">
    <!-- Moving Welcome Message -->
    <div class="welcome-message">ðŸŽ‰ Welcome to VBANKMFV! Enjoy Seamless Data Purchase ðŸŽ‰</div>
    
    <!-- User Balance Section (Fetched from Firebase) -->
    <div class="balance">ðŸ’° Your Balance: â‚¦ <span id="userBalance">Loading...</span></div>

    <!-- Data Purchase Form -->
    <form id="dataForm">
        <label for="dataType">Select Data Type</label>
        <select id="dataType" onchange="updatePlans()">
            <option value="sme">SME</option>
            <option value="gifting">Gifting</option>
            <option value="corporate">Corporate</option>
        </select>

        <label for="dataPlan">Select Data Plan</label>
        <select id="dataPlan" onchange="updateAmount()"></select>

        <label for="phoneNumber">Enter Phone Number</label>
        <input type="text" id="phoneNumber" placeholder="08123456789" maxlength="11" required>

        <div class="balance">Amount to Pay: â‚¦ <span id="amountDisplay">0</span></div>

        <button type="button" onclick="submitForm()">Pay Now</button>
    </form>
</div>

<script>
    // âœ… Firebase Configuration
    const firebaseConfig = {
        apiKey: "AIzaSyA1dzpeYvPixn7y3yPx-h6M031QLXJFXBc",
        authDomain: "vbankmfv.firebaseapp.com",
        projectId: "vbankmfv",
        storageBucket: "vbankmfv.firebasestorage.app",
        messagingSenderId: "920021461554",
        appId: "1:920021461554:web:93e1f0ed565c78a04c2a2b",
        measurementId: "G-G37D2FP82T"
    };

    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // âœ… Fetch User Balance from Firestore
    const userUID = "testUser123"; // Change with the actual user's UID
    let userBalance = 0;

    db.collection("users").doc(userUID).get().then(doc => {
        if (doc.exists) {
            userBalance = doc.data().balance;
            document.getElementById("userBalance").innerText = userBalance;
        } else {
            alert("User not found!");
        }
    });

    // âœ… Data Plans
    const plans = {
        sme: { "500MB - â‚¦200": 200, "1GB - â‚¦280": 280 },
        gifting: { "500MB - â‚¦250": 250, "1GB - â‚¦300": 300 },
        corporate: { "500MB - â‚¦220": 220, "1GB - â‚¦310": 310 }
    };

    // âœ… Update Plans and Amount
    function updatePlans() {
        const type = document.getElementById("dataType").value;
        const planSelect = document.getElementById("dataPlan");
        planSelect.innerHTML = "";
        Object.keys(plans[type]).forEach(plan => {
            planSelect.innerHTML += `<option value="${plans[type][plan]}">${plan}</option>`;
        });
        updateAmount();
    }

    function updateAmount() {
        const planValue = document.getElementById("dataPlan").value;
        document.getElementById("amountDisplay").innerText = planValue;
    }

    // âœ… API Integration for Data Purchase
    async function submitForm() {
        const phoneNumber = document.getElementById("phoneNumber").value;
        const dataType = document.getElementById("dataType").value;
        const dataPlan = document.getElementById("dataPlan").value;

        if (userBalance < dataPlan) {
            alert("Insufficient balance! Please fund your wallet.");
            return;
        }

        const apiEndpoint = "https://chinedutopup.com.ng/api/data/";
        const apiToken = "bC6p3CABlEv70AkICCCtA7o3exCAyfcxmBBqGcB9h35AAgA1x981CaJ54Hs21725471118";

        const requestBody = {
            network: "1",  
            phone: phoneNumber,
            ref: Math.floor(Math.random() * 10000000000).toString(),
            data_plan: "1",  
            ported_number: false
        };

        try {
            const response = await fetch(apiEndpoint, {
                method: "POST",
                headers: {
                    "Token": apiToken,
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(requestBody)
            });

            const result = await response.json();
            if (result.success) {
                alert("Data purchase successful!");
                userBalance -= dataPlan;
                document.getElementById("userBalance").innerText = userBalance;
            } else {
                alert("Purchase failed! " + result.message);
            }
        } catch (error) {
            console.error("Error:", error);
            alert("An error occurred while processing your request.");
        }
    }

    // âœ… Initialize Default Plans
    updatePlans();
</script>
</body>
</html>
