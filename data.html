<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
    import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";

    // Firebase configuration
    const firebaseConfig = {
        apiKey: "AIzaSyA1dzpeYvPixn7y3yPx-h6M031QLXJFXBc",
        authDomain: "vbankmfv.firebaseapp.com",
        projectId: "vbankmfv",
        storageBucket: "vbankmfv.appspot.com",
        messagingSenderId: "920021461554",
        appId: "1:920021461554:web:93e1f0ed565c78a04c2a2b"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    let currentUserUID;
    let userBalance = 0;
    let userPin;

    // Data plans setup
    const dataPlans = {
        sme: [{ name: "SME 1GB", price: 160 }, { name: "SME 2GB", price: 520 }],
        gifting: [{ name: "Gifting 1GB", price: 180 }, { name: "Gifting 2GB", price: 560 }]
    };

    // Check if user is logged in
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            currentUserUID = user.uid;

            // Fetch balance from Firestore based on UID
            const balanceRef = doc(db, "balances", currentUserUID);
            const balanceDoc = await getDoc(balanceRef);
            if (balanceDoc.exists()) {
                const balanceData = balanceDoc.data();
                userBalance = balanceData.balance || 0;
                document.getElementById("userBalance").textContent = userBalance;
            } else {
                alert("Balance not found, please complete your profile.");
                window.location.href = "profile.html";
            }

            // Fetch PIN from Firestore
            const userRef = doc(db, "users", currentUserUID);
            const userDoc = await getDoc(userRef);
            if (userDoc.exists()) {
                const userData = userDoc.data();
                userPin = userData.pin;
            } else {
                alert("User data not found. Please complete your profile.");
                window.location.href = "profile.html";
            }
        } else {
            alert("You are not logged in!");
            window.location.href = "login.html";
        }
    });

    // Populate data plans based on data type selection
    const dataTypeSelect = document.getElementById("dataType");
    const dataPlanSelect = document.getElementById("dataPlan");
    const amountToPay = document.getElementById("amountToPay");

    dataTypeSelect.addEventListener("change", () => {
        const selectedType = dataTypeSelect.value;
        dataPlanSelect.innerHTML = "<option value=''>Select Plan</option>";
        dataPlans[selectedType].forEach(plan => {
            const option = document.createElement("option");
            option.value = plan.price;
            option.textContent = `${plan.name} - ₦${plan.price}`;
            dataPlanSelect.appendChild(option);
        });
    });

    // Update amount when a data plan is selected
    dataPlanSelect.addEventListener("change", () => {
        amountToPay.textContent = `₦${dataPlanSelect.value}`;
    });

    // Form submission logic
    document.getElementById("dataForm").addEventListener("submit", async (e) => {
        e.preventDefault();

        const phoneNumber = document.getElementById("phoneNumber").value;
        const selectedPlanPrice = Number(dataPlanSelect.value);
        const enteredPin = document.getElementById("pin").value;

        // Validate phone number format
        if (!/^[0]\d{10}$/.test(phoneNumber)) {
            alert("Phone number must be 11 digits starting with 0");
            return;
        }

        // Validate PIN
        if (enteredPin !== userPin) {
            alert("Incorrect PIN.");
            return;
        }

        // Check if user has enough balance
        if (userBalance < selectedPlanPrice) {
            alert("Insufficient balance. Please fund your wallet.");
            return;
        }

        // Prepare API request data
        const network = document.getElementById("network").value;
        const dataType = document.getElementById("dataType").value;
        const dataPlan = dataPlanSelect.selectedOptions[0].text;

        try {
            // Make the API call to deliver the data
            const response = await fetch("https://chinedutopup.com.ng/api/data/", {
                method: "POST",
                headers: {
                    "Token": "Token bC6p3CABlEv70AkICCCtA7o3exCAyfcxmBBqGcB9h35AAgA1x981CaJ54Hs21725471118",
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    network: network,
                    phone: phoneNumber,
                    ref: Date.now().toString(),
                    data_plan: dataPlan,
                    ported_number: false
                })
            });

            const data = await response.json();

            // Check API response
            if (response.ok && data.status === "success") {
                // Deduct balance only after successful data delivery
                const newBalance = userBalance - selectedPlanPrice;
                const balanceRef = doc(db, "balances", currentUserUID);
                await updateDoc(balanceRef, { balance: newBalance });

                alert("Data purchase successful!");
                window.location.href = "receipt.html";
            } else {
                // Refund the balance if the API fails
                alert("Purchase failed. No quantity available or error in API.");
            }
        } catch (error) {
            alert("Error connecting to API. Please try again later.");
        }
    });
</script>
